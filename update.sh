#!/bin/bash

APP_DIR="avatar-customizer"

echo "=== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Avatar Customizer ==="

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ -d "$SCRIPT_DIR/.git" ]; then
    # –°–∫—Ä–∏–ø—Ç –ª–µ–∂–∏—Ç –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞
    PROJECT_ROOT="$SCRIPT_DIR"
elif [ -d "$SCRIPT_DIR/$APP_DIR" ]; then
    # –°–∫—Ä–∏–ø—Ç –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å –ø–∞–ø–∫–æ–π –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ /root/)
    PROJECT_ROOT="$SCRIPT_DIR/$APP_DIR"
elif [ -d "$HOME/$APP_DIR" ]; then
    # –°–∫—Ä–∏–ø—Ç –≥–¥–µ-—Ç–æ –µ—â–µ, –Ω–æ –ø—Ä–æ–µ–∫—Ç –µ—Å—Ç—å –≤ –¥–æ–º–∞—à–Ω–µ–π –ø–∞–ø–∫–µ
    PROJECT_ROOT="$HOME/$APP_DIR"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ '$APP_DIR' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ '$APP_DIR' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
    exit 1
fi

echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_ROOT"
cd "$PROJECT_ROOT" || exit 1

# 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –±—ã–ª–∏) –∏ –ø–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥
echo "[1/3] ‚¨áÔ∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
git reset --hard
git pull origin main

# 2. –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "[2/3] üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫..."
npm install

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
echo "[3/3] üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
pm2 restart avatar-app

echo "=== ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! ==="
pm2 status
